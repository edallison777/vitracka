name: Infrastructure Monitoring & Alerting

on:
  schedule:
    # Run every 15 minutes
    - cron: '*/15 * * * *'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to monitor'
        required: true
        default: 'production'
        type: choice
        options:
        - development
        - staging
        - production
        - all

env:
  AWS_REGION: 'eu-west-2'

jobs:
  infrastructure-health-check:
    name: Infrastructure Health Check
    runs-on: ubuntu-latest
    strategy:
      matrix:
        environment: ${{ github.event.inputs.environment == 'all' && fromJson('["development", "staging", "production"]') || fromJson(format('["{0}"]', github.event.inputs.environment || 'production')) }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets[format('AWS_ACCESS_KEY_ID_{0}', upper(matrix.environment))] }}
        aws-secret-access-key: ${{ secrets[format('AWS_SECRET_ACCESS_KEY_{0}', upper(matrix.environment))] }}
        aws-region: ${{ env.AWS_REGION }}
        
    - name: Check ALB Health
      id: alb-health
      run: |
        echo "Checking ALB health for ${{ matrix.environment }}..."
        
        # Get ALB ARN from tags
        ALB_ARN=$(aws elbv2 describe-load-balancers \
          --query "LoadBalancers[?contains(Tags[?Key=='Environment'].Value, '${{ matrix.environment }}')].LoadBalancerArn" \
          --output text)
          
        if [ -z "$ALB_ARN" ]; then
          echo "âŒ ALB not found for ${{ matrix.environment }}"
          echo "status=failed" >> $GITHUB_OUTPUT
          exit 1
        fi
        
        # Check ALB state
        ALB_STATE=$(aws elbv2 describe-load-balancers \
          --load-balancer-arns $ALB_ARN \
          --query "LoadBalancers[0].State.Code" \
          --output text)
          
        if [ "$ALB_STATE" = "active" ]; then
          echo "âœ… ALB is active for ${{ matrix.environment }}"
          echo "status=healthy" >> $GITHUB_OUTPUT
        else
          echo "âŒ ALB is not active for ${{ matrix.environment }}: $ALB_STATE"
          echo "status=unhealthy" >> $GITHUB_OUTPUT
        fi
        
    - name: Check RDS Health
      id: rds-health
      run: |
        echo "Checking RDS health for ${{ matrix.environment }}..."
        
        # Get RDS instance identifier
        DB_INSTANCE=$(aws rds describe-db-instances \
          --query "DBInstances[?contains(TagList[?Key=='Environment'].Value, '${{ matrix.environment }}')].DBInstanceIdentifier" \
          --output text)
          
        if [ -z "$DB_INSTANCE" ]; then
          echo "âŒ RDS instance not found for ${{ matrix.environment }}"
          echo "status=failed" >> $GITHUB_OUTPUT
          exit 1
        fi
        
        # Check RDS status
        DB_STATUS=$(aws rds describe-db-instances \
          --db-instance-identifier $DB_INSTANCE \
          --query "DBInstances[0].DBInstanceStatus" \
          --output text)
          
        if [ "$DB_STATUS" = "available" ]; then
          echo "âœ… RDS is available for ${{ matrix.environment }}"
          echo "status=healthy" >> $GITHUB_OUTPUT
        else
          echo "âŒ RDS is not available for ${{ matrix.environment }}: $DB_STATUS"
          echo "status=unhealthy" >> $GITHUB_OUTPUT
        fi
        
    - name: Check ECS Services Health
      id: ecs-health
      run: |
        echo "Checking ECS services health for ${{ matrix.environment }}..."
        
        # Get ECS cluster name
        CLUSTER_NAME=$(aws ecs list-clusters \
          --query "clusterArns[?contains(@, '${{ matrix.environment }}')]" \
          --output text | head -1)
          
        if [ -z "$CLUSTER_NAME" ]; then
          echo "âŒ ECS cluster not found for ${{ matrix.environment }}"
          echo "status=failed" >> $GITHUB_OUTPUT
          exit 1
        fi
        
        # Check ECS services
        SERVICES=$(aws ecs list-services --cluster $CLUSTER_NAME --query "serviceArns" --output text)
        
        UNHEALTHY_SERVICES=0
        TOTAL_SERVICES=0
        
        for SERVICE_ARN in $SERVICES; do
          TOTAL_SERVICES=$((TOTAL_SERVICES + 1))
          
          SERVICE_STATUS=$(aws ecs describe-services \
            --cluster $CLUSTER_NAME \
            --services $SERVICE_ARN \
            --query "services[0].status" \
            --output text)
            
          RUNNING_COUNT=$(aws ecs describe-services \
            --cluster $CLUSTER_NAME \
            --services $SERVICE_ARN \
            --query "services[0].runningCount" \
            --output text)
            
          DESIRED_COUNT=$(aws ecs describe-services \
            --cluster $CLUSTER_NAME \
            --services $SERVICE_ARN \
            --query "services[0].desiredCount" \
            --output text)
            
          if [ "$SERVICE_STATUS" != "ACTIVE" ] || [ "$RUNNING_COUNT" != "$DESIRED_COUNT" ]; then
            UNHEALTHY_SERVICES=$((UNHEALTHY_SERVICES + 1))
            echo "âŒ Service $SERVICE_ARN is unhealthy: Status=$SERVICE_STATUS, Running=$RUNNING_COUNT, Desired=$DESIRED_COUNT"
          fi
        done
        
        if [ $UNHEALTHY_SERVICES -eq 0 ]; then
          echo "âœ… All $TOTAL_SERVICES ECS services are healthy for ${{ matrix.environment }}"
          echo "status=healthy" >> $GITHUB_OUTPUT
        else
          echo "âŒ $UNHEALTHY_SERVICES out of $TOTAL_SERVICES ECS services are unhealthy for ${{ matrix.environment }}"
          echo "status=unhealthy" >> $GITHUB_OUTPUT
        fi
        
    - name: Check Application Endpoints
      id: app-health
      run: |
        echo "Checking application endpoints for ${{ matrix.environment }}..."
        
        # Get ALB DNS name
        ALB_DNS=$(aws elbv2 describe-load-balancers \
          --query "LoadBalancers[?contains(Tags[?Key=='Environment'].Value, '${{ matrix.environment }}')].DNSName" \
          --output text)
          
        if [ -z "$ALB_DNS" ]; then
          echo "âŒ ALB DNS not found for ${{ matrix.environment }}"
          echo "status=failed" >> $GITHUB_OUTPUT
          exit 1
        fi
        
        # Check health endpoint
        HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "http://$ALB_DNS/health" || echo "000")
        
        if [ "$HTTP_STATUS" = "200" ]; then
          echo "âœ… Application health endpoint is responding for ${{ matrix.environment }}"
          echo "status=healthy" >> $GITHUB_OUTPUT
        else
          echo "âŒ Application health endpoint is not responding for ${{ matrix.environment }}: HTTP $HTTP_STATUS"
          echo "status=unhealthy" >> $GITHUB_OUTPUT
        fi
        
    - name: Check CloudWatch Alarms
      id: cloudwatch-alarms
      run: |
        echo "Checking CloudWatch alarms for ${{ matrix.environment }}..."
        
        # Get alarms in ALARM state
        ALARM_NAMES=$(aws cloudwatch describe-alarms \
          --state-value ALARM \
          --query "MetricAlarms[?contains(AlarmName, '${{ matrix.environment }}')].AlarmName" \
          --output text)
          
        if [ -z "$ALARM_NAMES" ]; then
          echo "âœ… No active alarms for ${{ matrix.environment }}"
          echo "status=healthy" >> $GITHUB_OUTPUT
        else
          echo "âŒ Active alarms for ${{ matrix.environment }}:"
          for ALARM in $ALARM_NAMES; do
            echo "  - $ALARM"
          done
          echo "status=unhealthy" >> $GITHUB_OUTPUT
        fi
        
    - name: Generate Health Report
      run: |
        echo "## Infrastructure Health Report - ${{ matrix.environment }}" >> health_report.md
        echo "**Timestamp:** $(date -u)" >> health_report.md
        echo "" >> health_report.md
        
        echo "| Component | Status |" >> health_report.md
        echo "|-----------|--------|" >> health_report.md
        echo "| ALB | ${{ steps.alb-health.outputs.status == 'healthy' && 'âœ… Healthy' || 'âŒ Unhealthy' }} |" >> health_report.md
        echo "| RDS | ${{ steps.rds-health.outputs.status == 'healthy' && 'âœ… Healthy' || 'âŒ Unhealthy' }} |" >> health_report.md
        echo "| ECS Services | ${{ steps.ecs-health.outputs.status == 'healthy' && 'âœ… Healthy' || 'âŒ Unhealthy' }} |" >> health_report.md
        echo "| Application | ${{ steps.app-health.outputs.status == 'healthy' && 'âœ… Healthy' || 'âŒ Unhealthy' }} |" >> health_report.md
        echo "| CloudWatch Alarms | ${{ steps.cloudwatch-alarms.outputs.status == 'healthy' && 'âœ… No Active Alarms' || 'âŒ Active Alarms' }} |" >> health_report.md
        
        cat health_report.md
        
    - name: Upload Health Report
      uses: actions/upload-artifact@v4
      with:
        name: health-report-${{ matrix.environment }}
        path: health_report.md
        retention-days: 7
        
    - name: Send Alert if Unhealthy
      if: steps.alb-health.outputs.status == 'unhealthy' || steps.rds-health.outputs.status == 'unhealthy' || steps.ecs-health.outputs.status == 'unhealthy' || steps.app-health.outputs.status == 'unhealthy' || steps.cloudwatch-alarms.outputs.status == 'unhealthy'
      run: |
        echo "ðŸš¨ ALERT: Infrastructure issues detected in ${{ matrix.environment }}"
        echo "Please check the health report for details."
        
        # Here you would integrate with your alerting system
        # Examples:
        # - Send Slack notification
        # - Send email via SES
        # - Create PagerDuty incident
        # - Post to Teams webhook
        
        exit 1

  cost-monitoring:
    name: Cost Monitoring
    runs-on: ubuntu-latest
    if: github.event.schedule || github.event.inputs.environment == 'all' || github.event.inputs.environment == 'production'
    
    steps:
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID_PROD }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY_PROD }}
        aws-region: ${{ env.AWS_REGION }}
        
    - name: Check Daily Costs
      run: |
        echo "Checking daily costs..."
        
        # Get yesterday's costs
        YESTERDAY=$(date -d "yesterday" +%Y-%m-%d)
        TODAY=$(date +%Y-%m-%d)
        
        DAILY_COST=$(aws ce get-cost-and-usage \
          --time-period Start=$YESTERDAY,End=$TODAY \
          --granularity DAILY \
          --metrics BlendedCost \
          --group-by Type=DIMENSION,Key=SERVICE \
          --query "ResultsByTime[0].Total.BlendedCost.Amount" \
          --output text)
          
        echo "Daily cost for $YESTERDAY: \$$DAILY_COST"
        
        # Set cost threshold (example: $100/day)
        COST_THRESHOLD=100
        
        if (( $(echo "$DAILY_COST > $COST_THRESHOLD" | bc -l) )); then
          echo "ðŸš¨ COST ALERT: Daily cost (\$$DAILY_COST) exceeds threshold (\$$COST_THRESHOLD)"
          exit 1
        else
          echo "âœ… Daily cost is within threshold"
        fi